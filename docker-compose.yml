version: "3.9"
services:

  db-local:
    image: "postgres:13.10-alpine"
    container_name: pysect-backend-db-local
    restart: unless-stopped
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - pysect-network
    ports:
      - "9001:5432"
    env_file:
      - ./docker/config/.env.template

  redis-local:
    image: redis:latest
    container_name: pysect-backend-redis-local
    ports:
      - "9002:6379"
    networks:
      - pysect-network

  web-local:
    image: "pysect-backend-challenge-local"
    container_name: pysect-backend-challenge-local
    ports:
      - "9000:8000"
    #platform: linux/amd64
    build:
      target: builder_image
      context: .
      dockerfile: ./docker/django/Dockerfile
      args:
        DJANGO_ENV: development
        # See: https://github.com/wemake-services/wemake-django-template/issues/1518
        USER_ID: ${UID:-1000}
        USER_GID: ${GID:-1000}
    volumes:
      - django-static:/var/www/django/static
      - django-logs:/var/www/log
      # We should only mount source code in development:
      - .:/code
    depends_on:
      - db-local
    networks:
      - pysect-network
    env_file:
      - ./docker/config/.env.template
    command: ./docker/django/local_run.sh

networks:
  pysect-network:
    external: true


volumes:
  pgdata:
  django-static:
  django-logs:
